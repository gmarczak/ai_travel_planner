@page
@model project.Pages.TravelPlanner.IndexModel
@{
    ViewData["Title"] = "AI Travel Planner";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <h1 class="text-center mb-4 fw-bold">Create Your Travel Plan</h1>
            <p class="text-center text-muted mb-4">Fill in the details below to generate a personalized AI itinerary.
            </p>
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">Trip details</h4>
                </div>
                <div class="card-body p-4">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <strong>Fix the issues below:</strong>
                            <div asp-validation-summary="All" class="mt-2"></div>
                        </div>
                    }

                    <form method="post" id="travelForm">
                        @Html.AntiForgeryToken()
                        <!-- DESTINATION & DATES -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">Destination & Dates
                            </legend>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="TravelRequest.Destination" class="form-label">Destination *</label>
                                    <input asp-for="TravelRequest.Destination" class="form-control"
                                        placeholder="e.g. Barcelona" required />
                                    <span asp-validation-for="TravelRequest.Destination"
                                        class="text-danger small"></span>
                                </div>
                                <div class="col-md-3">
                                    <label asp-for="TravelRequest.StartDate" class="form-label">Start *</label>
                                    <input asp-for="TravelRequest.StartDate" type="date" class="form-control"
                                        required />
                                    <span asp-validation-for="TravelRequest.StartDate" class="text-danger small"></span>
                                </div>
                                <div class="col-md-3">
                                    <label asp-for="TravelRequest.EndDate" class="form-label">End *</label>
                                    <input asp-for="TravelRequest.EndDate" type="date" class="form-control" required />
                                    <span asp-validation-for="TravelRequest.EndDate" class="text-danger small"></span>
                                </div>
                            </div>
                        </fieldset>

                        <!-- TRAVELERS / BUDGET / TYPE -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">People & Budget
                            </legend>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label asp-for="TravelRequest.NumberOfTravelers" class="form-label">Travelers
                                        *</label>
                                    <input asp-for="TravelRequest.NumberOfTravelers" type="number" min="1" max="20"
                                        class="form-control" required />
                                    <span asp-validation-for="TravelRequest.NumberOfTravelers"
                                        class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="TravelRequest.Budget" class="form-label">Total Budget (USD)
                                        *</label>
                                    <input asp-for="TravelRequest.Budget" type="number" min="100" step="50"
                                        class="form-control" placeholder="e.g. 2500" required />
                                    <span asp-validation-for="TravelRequest.Budget" class="text-danger small"></span>
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="TravelRequest.TripType" class="form-label">Trip Type</label>
                                    <select asp-for="TravelRequest.TripType" class="form-select">
                                        <option value="">(optional)</option>
                                        <option value="Adventure">Adventure</option>
                                        <option value="Relaxation">Relaxation</option>
                                        <option value="Cultural">Cultural</option>
                                        <option value="Business">Business</option>
                                        <option value="Family">Family</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>

                        <!-- NOTE: Interests removed — form includes only destination, dates, travelers, budget, trip type, and preferences -->

                        <!-- PREFERENCES -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">Additional
                                Preferences</legend>
                            <textarea asp-for="TravelRequest.TravelPreferences" class="form-control" rows="3"
                                placeholder="Dietary needs, accessibility, pace, style, must-see spots..."></textarea>
                        </fieldset>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
                                    style="display: none;" id="loadingSpinner"></span>
                                <span id="buttonText">Generate Travel Plan</span>
                            </button>
                        </div>

                        <!-- Progress Bar UI -->
                        <div id="progressContainer" class="mt-4" style="display:none;">
                            <div class="progress mb-2" style="height: 30px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                    id="formProgressBar" role="progressbar" style="width: 10%;" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
                                    <span id="formProgressText" class="fw-bold">10%</span>
                                </div>
                            </div>
                            <div class="small text-muted" id="progressStatus">Preparing...</div>
                        </div>

                        <!-- Language selection removed from form. Language is taken from the header selector (cookie). -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">* Required fields — Processing time: a few seconds</small>
                        </div>
                    </form>
                </div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">Powered by AI � Optimized for clarity</small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/%40microsoft/signalr@7.0.14/dist/browser/signalr.min.js"></script>
    <script>
        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.querySelector('input[name="TravelRequest.StartDate"]');
        const endDateInput = document.querySelector('input[name="TravelRequest.EndDate"]');
        if (startDateInput) {
            startDateInput.min = today;
            if (!startDateInput.value) {
                const defaultStart = new Date();
                defaultStart.setDate(defaultStart.getDate() + 14);
                startDateInput.value = defaultStart.toISOString().split('T')[0];
            }
            startDateInput.addEventListener('change', function () {
                if (endDateInput) {
                    endDateInput.min = this.value;
                    if (endDateInput.value && endDateInput.value < this.value) {
                        const s = new Date(this.value); s.setDate(s.getDate() + 7); endDateInput.value = s.toISOString().split('T')[0];
                    }
                }
            });
        }
        if (endDateInput && !endDateInput.value) {
            const defaultEnd = new Date();
            defaultEnd.setDate(defaultEnd.getDate() + 21);
            endDateInput.value = defaultEnd.toISOString().split('T')[0];
        }

        // SignalR Connection
        let connection = null;
        let currentPlanId = null;

        async function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/planGeneration")
                .withAutomaticReconnect()
                .build();

            connection.on("ProgressUpdate", function (data) {
                console.log("Progress update received:", data);
                
                // Only update if this is our plan
                if (!currentPlanId || data.planId === currentPlanId) {
                    updateProgress(data.progress, data.message);
                    
                    if (data.status === "Completed") {
                        // Redirect to result page after completion
                        updateProgress(100, "Plan completed! Redirecting...");
                        setTimeout(() => {
                            window.location.href = `/TravelPlanner/Result?id=${data.planId}`;
                        }, 1000);
                    } else if (data.status === "Failed") {
                        showError(data.message || "Failed to generate plan");
                    }
                }
            });

            try {
                await connection.start();
                console.log("SignalR connected");
            } catch (err) {
                console.error("SignalR connection error:", err);
            }
        }

        function updateProgress(percentage, message) {
            // Show and update the progress bar on the form page
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('formProgressBar');
            const text = document.getElementById('formProgressText');
            const status = document.getElementById('progressStatus');
            if (container && bar && text && status) {
                container.style.display = '';
                bar.style.width = percentage + '%';
                bar.setAttribute('aria-valuenow', percentage);
                text.textContent = percentage + '%';
                status.textContent = message || '';
            }
            console.log(`Progress: ${percentage}% - ${message}`);
        }

        function showError(message) {
            const btn = document.getElementById('generateBtn');
            const spn = document.getElementById('loadingSpinner');
            const txt = document.getElementById('buttonText');
            const progressContainer = document.getElementById('progressContainer');
            
            if (btn && spn && txt) {
                btn.disabled = false;
                spn.style.display = 'none';
                txt.textContent = 'Generate Travel Plan';
            }
            
            // Hide progress bar
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            
            // Show error toast
            if (window.Toast) {
                Toast.error(message || 'Failed to generate plan. Please try again.');
            } else {
                alert(message || 'Failed to generate plan. Please try again.');
            }
        }

        const form = document.getElementById('travelForm');
        if (form) {
            form.addEventListener('submit', async function (e) {
                e.preventDefault(); // Prevent normal form submission
                
                const btn = document.getElementById('generateBtn');
                const spn = document.getElementById('loadingSpinner');
                const txt = document.getElementById('buttonText');
                
                if (btn && spn && txt) {
                    btn.disabled = true;
                    spn.style.display = 'inline-block';
                    txt.textContent = 'Creating your plan...';
                }

                // Initialize SignalR if not already connected
                if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                    await initializeSignalR();
                }
                
                updateProgress(5, "Preparing to generate your travel plan...");

                // Submit form via AJAX
                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        currentPlanId = result.planId;
                        console.log('Plan generation started:', currentPlanId);
                        updateProgress(10, "Plan queued for generation...");
                        
                        // Join SignalR group for this plan
                        if (connection && connection.state === signalR.HubConnectionState.Connected) {
                            await connection.invoke("JoinPlanGeneration", currentPlanId);
                        }
                    } else {
                        showError(result.error || 'Failed to start plan generation');
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showError('Network error. Please check your connection and try again.');
                }
            });
        }

        // Initialize SignalR on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSignalR();
        });
    </script>
}