@page
@model project.Pages.TravelPlanner.IndexModel
@{
    ViewData["Title"] = "Travel Planner";
}

<style>
    /* Mobile: larger touch targe            <h1 class="text-center mb-3 mb-md-4 fw-bold fs-2 fs-md-1">Create Your Travel Plan</h1>
            <p class="text-center text-muted mb-3 mb-md-4 small">Fill in the details below to get your personalized travel plan
            </p>
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-2 py-3">
                    <h4 class="mb-0 fs-5 fs-md-4">Trip Details</h4>
    .travelers-btn {
        min-height: 44px;
    }

    /* Desktop: normal button height */
    @@media (min-width: 768px) {
        .travelers-btn {
            min-height: auto;
        }
    }

    /* Improved font visibility for mobile and desktop */
    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.4rem;
    }

    .form-control,
    .form-select {
        font-size: 1rem;
        color: #212529;
        border: 1.5px solid #ced4da;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    }

    .form-control::placeholder {
        color: #6c757d;
        opacity: 0.7;
    }

    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.4;
    }

    legend.h6 {
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.3px;
    }

    /* Mobile optimizations */
    @@media (max-width: 767px) {
        .form-label {
            font-size: 0.95rem;
        }

        .form-control,
        .form-select {
            font-size: 1.05rem;
            padding: 0.6rem 0.75rem;
        }

        .form-text {
            font-size: 0.875rem;
        }

        legend.h6 {
            font-size: 1rem;
        }
    }

    /* Desktop optimizations */
    @@media (min-width: 768px) {
        .form-label {
            font-size: 0.9rem;
        }

        .form-control,
        .form-select {
            font-size: 0.95rem;
            padding: 0.5rem 0.75rem;
        }

        .form-text {
            font-size: 0.8rem;
        }

        legend.h6 {
            font-size: 0.95rem;
        }
    }

    /* Autocomplete dropdown styling */
    .pac-container {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 1rem;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        margin-top: 4px;
    }

    .pac-item {
        padding: 0.6rem 0.75rem;
        border-top: 1px solid #e9ecef;
        cursor: pointer;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .pac-item:hover {
        background-color: #f8f9fa;
    }

    .pac-item-selected {
        background-color: #e7f1ff;
    }

    .pac-icon {
        margin-top: 4px;
    }

    .pac-item-query {
        font-weight: 600;
        color: #212529;
    }

    @@media (max-width: 767px) {
        .pac-container {
            font-size: 1.05rem;
        }

        .pac-item {
            padding: 0.75rem 0.85rem;
            font-size: 1rem;
        }
    }
</style>

<div class="container mt-3 mt-md-5 px-2 px-md-3">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <h1 class="text-center mb-3 mb-md-4 fw-bold fs-2 fs-md-1">@Localizer["createTravelPlan"]</h1>
            <p class="text-center text-muted mb-3 mb-md-4 small">@Localizer["fillInDetails"]
            </p>
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-2 py-md-3">
                    <h4 class="mb-0 fs-5 fs-md-4">@Localizer["tripDetails"]</h4>
                </div>
                <div class="card-body p-3 p-md-4">
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <strong>@Localizer["fixIssues"]</strong>
                            <div asp-validation-summary="All" class="mt-2"></div>
                        </div>
                    }

                    <form method="post" id="travelForm">
                        @Html.AntiForgeryToken()
                        <!-- DESTINATION & DATES -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">
                                @Localizer["destinationAndDates"]
                            </legend>
                            <div class="row g-2 g-md-3">
                                <div class="col-12 col-md-6">
                                    <label asp-for="TravelRequest.Destination"
                                        class="form-label">@Localizer["whereToGo"] <span
                                            class="text-danger">*</span></label>
                                    <input asp-for="TravelRequest.Destination" id="destinationInput"
                                        class="form-control" placeholder="@Localizer["destinationPlaceholder"]"
                                        autocomplete="off" autocapitalize="words" required />
                                    <span asp-validation-for="TravelRequest.Destination"
                                        class="text-danger small"></span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label asp-for="TravelRequest.StartDate"
                                        class="form-label small">@Localizer["startDate"] *</label>
                                    <input asp-for="TravelRequest.StartDate" type="date"
                                        class="form-control form-control-sm form-control-md-normal" required />
                                    <span asp-validation-for="TravelRequest.StartDate" class="text-danger small"></span>
                                </div>
                                <div class="col-6 col-md-3">
                                    <label asp-for="TravelRequest.EndDate" class="form-label small">@Localizer["endDate"]
                                        *</label>
                                    <input asp-for="TravelRequest.EndDate" type="date"
                                        class="form-control form-control-sm form-control-md-normal" required />
                                    <span asp-validation-for="TravelRequest.EndDate" class="text-danger small"></span>
                                </div>
                            </div>
                        </fieldset>

                        <!-- TRAVELERS / BUDGET / TYPE -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">
                                @Localizer["peopleAndBudget"]
                            </legend>
                            <div class="row g-2 g-md-3">
                                <div class="col-6 col-md-4">
                                    <label asp-for="TravelRequest.NumberOfTravelers"
                                        class="form-label small">@Localizer["numberOfTravelers"]
                                        *</label>
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary travelers-btn" type="button"
                                            id="decrementTravelers">
                                            <i class="bi bi-dash-lg"></i>
                                        </button>
                                        <input asp-for="TravelRequest.NumberOfTravelers" type="number" min="1" max="20"
                                            inputmode="numeric" pattern="[0-9]*" autocomplete="off"
                                            class="form-control form-control-sm form-control-md-normal text-center"
                                            id="travelersInput" required readonly />
                                        <button class="btn btn-outline-secondary travelers-btn" type="button"
                                            id="incrementTravelers">
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="TravelRequest.NumberOfTravelers"
                                        class="text-danger small"></span>
                                </div>
                                <div class="col-6 col-md-4">
                                    <label asp-for="TravelRequest.Budget" class="form-label small">@Localizer["budget"]
                                        *</label>
                                    <input asp-for="TravelRequest.Budget" type="number" min="100" step="50"
                                        inputmode="decimal" enterkeyhint="done" autocomplete="off"
                                        class="form-control form-control-sm form-control-md-normal" placeholder="@Localizer["budgetPlaceholder"]"
                                        required />
                                    <span asp-validation-for="TravelRequest.Budget" class="text-danger small"></span>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label asp-for="TravelRequest.TripType"
                                        class="form-label small">@Localizer["tripType"]</label>
                                    <select asp-for="TravelRequest.TripType"
                                        class="form-select form-select-sm form-select-md-normal">
                                        <option value="">@Localizer["optional"]</option>
                                        <option value="Adventure">@Localizer["adventure"]</option>
                                        <option value="Relaxation">@Localizer["relaxation"]</option>
                                        <option value="Cultural">@Localizer["cultural"]</option>
                                        <option value="Business">@Localizer["business"]</option>
                                        <option value="Family">@Localizer["family"]</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>

                        <!-- TRANSPORT MODE -->
                        <fieldset class="mb-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-3">
                                @Localizer["transport"]</legend>
                            <div class="row g-2 g-md-3">
                                <div class="col-12 col-md-6">
                                    <label asp-for="TravelRequest.DepartureLocation"
                                        class="form-label">@Localizer["travelingFrom"] <span
                                            class="text-muted fw-normal">@Localizer["optionalField"]</span></label>
                                    <input asp-for="TravelRequest.DepartureLocation" id="departureInput"
                                        class="form-control" placeholder="@Localizer["departurePlaceholder"]"
                                        autocomplete="off" autocapitalize="words" />
                                    <small class="form-text mt-1 d-block">ðŸ’¡ @Localizer["helpsFlights"]</small>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label asp-for="TravelRequest.TransportMode"
                                        class="form-label small">@Localizer["howTraveling"]</label>
                                    <select asp-for="TravelRequest.TransportMode"
                                        class="form-select form-select-sm form-select-md-normal">
                                        <option value="">@Localizer["optionalAiSuggest"]</option>
                                        <option value="Flight">@Localizer["flight"]</option>
                                        <option value="Car">@Localizer["car"]</option>
                                        <option value="Train">@Localizer["train"]</option>
                                        <option value="Bus">@Localizer["bus"]</option>
                                    </select>
                                    <small class="form-text text-muted mt-1 d-block">ðŸ’¡
                                        @Localizer["helpsAiSuggest"]</small>
                                </div>
                            </div>
                        </fieldset>

                        <!-- NOTE: Interests removed â€” form includes only destination, dates, travelers, budget, trip type, and preferences -->

                        <!-- PREFERENCES -->
                        <fieldset class="mb-3 mb-md-4">
                            <legend class="h6 text-uppercase small fw-semibold text-secondary mb-2 mb-md-3">
                                @Localizer["additionalPreferences"]</legend>
                            <textarea asp-for="TravelRequest.TravelPreferences"
                                class="form-control form-control-sm form-control-md-normal" rows="3"
                                placeholder="@Localizer["examplesPreferences"]"></textarea>
                            <small class="form-text text-muted mt-1 d-block">ðŸ’¡ @Localizer["beSpecific"]</small>
                        </fieldset>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="generateBtn"
                                style="min-height: 44px;">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
                                    style="display: none;" id="loadingSpinner"></span>
                                <span id="buttonText">@Localizer["generatePlan"]</span>
                            </button>
                        </div>

                        <!-- Progress Bar UI -->
                        <div id="progressContainer" class="mt-3 mt-md-4" style="display:none;">
                            <div class="progress mb-2" style="height: 24px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                    id="formProgressBar" role="progressbar" style="width: 10%;" aria-valuenow="10"
                                    aria-valuemin="0" aria-valuemax="100">
                                    <span id="formProgressText" class="fw-bold small">10%</span>
                                </div>
                            </div>
                            <div class="small text-muted" id="progressStatus">@Localizer["preparing"]</div>
                        </div>

                        <!-- Language selection removed from form. Language is taken from the header selector (cookie). -->
                        <div class="mt-3 text-center">
                            <small class="text-muted d-block d-sm-inline">* @Localizer["requiredFields"]</small>
                            <small class="text-muted d-none d-sm-inline"> â€” @Localizer["processingTime"]</small>
                        </div>
                    </form>
                </div>
            </div>
            <div class="text-center mt-3">
                <small class="text-muted">Powered by AI ï¿½ Optimized for clarity</small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/destination-autocomplete.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/%40microsoft/signalr@7.0.14/dist/browser/signalr.min.js"
        onerror="console.warn('Primary SignalR CDN failed');"></script>
    <script>
        // Ensure signalR is available (fallback loaders if initial CDN missing)
        async function ensureSignalRLoaded() {
            if (window.signalR) return true;
            const fallbacks = [
                'https://unpkg.com/%40microsoft/signalr@7.0.14/dist/browser/signalr.min.js',
                'https://cdn.jsdelivr.net/npm/%40microsoft/signalr@7.0.14/dist/browser/signalr.min.js'
            ];
            for (const url of fallbacks) {
                try {
                    await new Promise((resolve, reject) => {
                        const s = document.createElement('script');
                        s.src = url;
                        s.async = true;
                        s.onload = resolve;
                        s.onerror = reject;
                        document.head.appendChild(s);
                    });
                    if (window.signalR) return true;
                } catch (e) {
                    console.warn('Failed loading fallback', url);
                }
            }
            console.error('SignalR script could not be loaded.');
            return false;
        }
        // Destination autocomplete
        document.addEventListener('DOMContentLoaded', function () {
            const destinationInput = document.getElementById('destinationInput');
            const destinationDatalist = document.getElementById('destinationSuggestions');
            let debounceTimer;

            console.log('Autocomplete initialized:', {
                input: !!destinationInput,
                datalist: !!destinationDatalist
            });

            if (destinationInput && destinationDatalist) {
                destinationInput.addEventListener('input', function () {
                    clearTimeout(debounceTimer);
                    const query = this.value.trim();

                    if (query.length < 2) {
                        destinationDatalist.innerHTML = '';
                        return;
                    }

                    debounceTimer = setTimeout(async () => {
                        try {
                            const url = `/TravelPlanner/Index?handler=DestinationSuggestions&query=${encodeURIComponent(query)}`;
                            console.log('Fetching suggestions for:', query, 'URL:', url);

                            const response = await fetch(url);
                            console.log('Response status:', response.status);

                            if (response.ok) {
                                const suggestions = await response.json();
                                console.log('Suggestions received:', suggestions.length);

                                destinationDatalist.innerHTML = suggestions
                                    .map(dest => `<option value="${dest}">`)
                                    .join('');
                            } else {
                                console.warn('Failed to fetch suggestions:', response.status, response.statusText);
                            }
                        } catch (error) {
                            console.error('Error fetching destination suggestions:', error);
                        }
                    }, 300); // 300ms debounce
                });
            } else {
                console.warn('Autocomplete elements not found');
            }
        });

        // Travelers increment/decrement buttons
        const travelersInput = document.getElementById('travelersInput');
        const incrementBtn = document.getElementById('incrementTravelers');
        const decrementBtn = document.getElementById('decrementTravelers');

        if (travelersInput && incrementBtn && decrementBtn) {
            // Set default value if empty
            if (!travelersInput.value) {
                travelersInput.value = 2;
            }

            incrementBtn.addEventListener('click', function () {
                let currentValue = parseInt(travelersInput.value) || 1;
                let maxValue = parseInt(travelersInput.getAttribute('max')) || 20;
                if (currentValue < maxValue) {
                    travelersInput.value = currentValue + 1;
                }
            });

            decrementBtn.addEventListener('click', function () {
                let currentValue = parseInt(travelersInput.value) || 1;
                let minValue = parseInt(travelersInput.getAttribute('min')) || 1;
                if (currentValue > minValue) {
                    travelersInput.value = currentValue - 1;
                }
            });
        }

        const today = new Date().toISOString().split('T')[0];
        const startDateInput = document.querySelector('input[name="TravelRequest.StartDate"]');
        const endDateInput = document.querySelector('input[name="TravelRequest.EndDate"]');
        if (startDateInput) {
            startDateInput.min = today;
            if (!startDateInput.value) {
                const defaultStart = new Date();
                defaultStart.setDate(defaultStart.getDate() + 14);
                startDateInput.value = defaultStart.toISOString().split('T')[0];
            }
            startDateInput.addEventListener('change', function () {
                if (endDateInput) {
                    endDateInput.min = this.value;
                    if (endDateInput.value && endDateInput.value < this.value) {
                        const s = new Date(this.value); s.setDate(s.getDate() + 7); endDateInput.value = s.toISOString().split('T')[0];
                    }
                }
            });
        }
        if (endDateInput && !endDateInput.value) {
            const defaultEnd = new Date();
            defaultEnd.setDate(defaultEnd.getDate() + 21);
            endDateInput.value = defaultEnd.toISOString().split('T')[0];
        }

        // SignalR Connection
        let connection = null;
        let currentPlanId = null;

        async function initializeSignalR() {
            const ok = await ensureSignalRLoaded();
            if (!ok) return;
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/planGeneration")
                .withAutomaticReconnect()
                .build();

            connection.on("ProgressUpdate", function (data) {
                console.log("Progress update received:", data);

                // Only update if this is our plan
                if (!currentPlanId || data.planId === currentPlanId) {
                    updateProgress(data.progress, data.message);

                    if (data.status === "Completed") {
                        // Redirect to result page after completion
                        updateProgress(100, "Plan completed! Redirecting...");
                        setTimeout(() => {
                            window.location.href = `/TravelPlanner/Result?id=${data.planId}`;
                        }, 1000);
                    } else if (data.status === "Failed") {
                        showError(data.message || "Failed to generate plan");
                    }
                }
            });

            // Handle explicit completion event from backend
            connection.on("PlanCompleted", function (data) {
                if (!currentPlanId || data.planId === currentPlanId) {
                    updateProgress(100, "Plan completed! Redirecting...");
                    setTimeout(() => {
                        window.location.href = `/TravelPlanner/Result?id=${data.planId}`;
                    }, 800);
                }
            });

            // Handle explicit failure event from backend
            connection.on("PlanFailed", function (data) {
                if (!currentPlanId || data.planId === currentPlanId) {
                    showError(data.message || "Failed to generate plan");
                }
            });

            try {
                await connection.start();
                console.log("SignalR connected");
            } catch (err) {
                console.error("SignalR connection error:", err);
            }
        }

        function updateProgress(percentage, message) {
            // Show and update the progress bar on the form page
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('formProgressBar');
            const text = document.getElementById('formProgressText');
            const status = document.getElementById('progressStatus');
            if (container && bar && text && status) {
                container.style.display = '';
                bar.style.width = percentage + '%';
                bar.setAttribute('aria-valuenow', percentage);
                text.textContent = percentage + '%';
                status.textContent = message || '';
            }
            console.log(`Progress: ${percentage}% - ${message}`);
        }

        function showError(message) {
            const btn = document.getElementById('generateBtn');
            const spn = document.getElementById('loadingSpinner');
            const txt = document.getElementById('buttonText');
            const progressContainer = document.getElementById('progressContainer');

            if (btn && spn && txt) {
                btn.disabled = false;
                spn.style.display = 'none';
                txt.textContent = 'Generate Travel Plan';
            }

            // Hide progress bar
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }

            // Show error toast
            if (window.Toast) {
                Toast.error(message || 'Failed to generate plan. Please try again.');
            } else {
                alert(message || 'Failed to generate plan. Please try again.');
            }
        }

        const form = document.getElementById('travelForm');
        if (form) {
            form.addEventListener('submit', async function (e) {
                e.preventDefault(); // Prevent normal form submission

                const btn = document.getElementById('generateBtn');
                const spn = document.getElementById('loadingSpinner');
                const txt = document.getElementById('buttonText');

                if (btn && spn && txt) {
                    btn.disabled = true;
                    spn.style.display = 'inline-block';
                    txt.textContent = i18n.t('creatingYourPlan');
                }

                // Initialize SignalR if not already connected
                if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                    await initializeSignalR();
                }

                updateProgress(5, "Preparing to generate your travel plan...");

                // Submit form via AJAX
                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action || window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        currentPlanId = result.planId;
                        console.log('Plan generation started:', currentPlanId);
                        updateProgress(10, "Plan queued for generation...");

                        // Join SignalR group for this plan
                        if (connection && connection.state === signalR.HubConnectionState.Connected) {
                            await connection.invoke("JoinPlanGeneration", currentPlanId);
                        }
                    } else {
                        showError(result.error || 'Failed to start plan generation');
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showError('Network error. Please check your connection and try again.');
                }
            });
        }

        // Initialize SignalR on page load
        document.addEventListener('DOMContentLoaded', async function () {
            await initializeSignalR();
        });
    </script>
}